# How to run Kafka (with optional mTLS) and produce data

This setup exposes both PLAINTEXT and SSL listeners. The SSL listener requires client certificate authentication (mTLS) and is intended to test the app using CA/cert/key PEMs.

Steps:

1) Generate test certificates (creates CA, server keystore/truststore, client PEMs, and a password file used by the broker)

```bash
cd local-test
bash ./generate-certs.sh
```

2) Start Kafka, Zookeeper, and a sample producer

```bash
docker compose up -d
```

Listeners:
- PLAINTEXT: `localhost:9092`
- SSL (mTLS required): `localhost:9093`

Topic: `random-data` (10 partitions)

Files generated by `generate-certs.sh` (under `local-test/certs/`):
- `ca.crt` / `ca.key`: Root CA (self‑signed). You use `ca.crt`.
- `server.crt` / `server.key`: Broker certs (used by the broker only).
- `client.crt` / `client.key`: Client certificate + private key — these are your app’s public/private “keys”.
- `kafka.keystore.jks` / `kafka.truststore.jks`: Broker keystore/truststore.
- `client-ssl.properties`: Convenience config for console tools inside the container.
- `password.txt`: Contains the keystore/truststore/key password (literal `password`). The compose file passes this into the cp‑kafka image using the required `KAFKA_SSL_*_CREDENTIALS` environment variables. Do not delete this file.

Map these into the app Environment modal (or CLI) like this:
- Private Key (PEM) → paste contents of `local-test/certs/client.key` (sets `--ssl-key-pem`)
- Public/Certificate (PEM) → paste contents of `local-test/certs/client.crt` (sets `--ssl-certificate-pem`)
- CA (PEM) → paste contents of `local-test/certs/ca.crt` (sets `--ssl-ca-pem`)

Notes:
- The TUI environment modal accepts PEM contents (multiline) for all three fields. There is no file‑path toggle; paste the PEMs directly.
- The CLI also accepts PEM contents via flags shown below.

Librdkafka properties the app sets:
- `security.protocol=SSL`
- `ssl.key.pem` (private key PEM)
- `ssl.certificate.pem` (client certificate PEM)
- `ssl.ca.pem` (CA PEM inline)

# Validate

Plaintext consume (broker `localhost:9092`):
```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic random-data \
  --from-beginning \
  --max-messages 10
```

SSL/mTLS consume from inside the container (broker `localhost:9093`):
```bash
docker exec -it kafka kafka-console-consumer \
  --bootstrap-server localhost:9093 \
  --consumer.config /etc/kafka/secrets/client-ssl.properties \
  --topic random-data \
  --from-beginning \
  --max-messages 10
```

Using the CLI (optional) with the same secrets:
```bash
# Inline PEMs
rkl run \
  --broker localhost:9093 \
  --topic random-data \
  --ssl-key-pem           "$(cat local-test/certs/client.key)" \
  --ssl-certificate-pem   "$(cat local-test/certs/client.crt)" \
  --ssl-ca-pem            "$(cat local-test/certs/ca.crt)"
```

In the TUI: open the Environment modal (Enter on the Environment bar), paste the three PEMs as shown above, press F5 to test, then F4 to save.

Troubleshooting broker startup
- Ensure you ran `./generate-certs.sh` before `docker compose up -d`; this creates `password.txt` used for keystore/truststore/key credentials.
- The compose file sets both `KAFKA_SSL_*_FILENAME` and `KAFKA_SSL_*_CREDENTIALS` as required by the Confluent image. Do not change credential variables to absolute paths; the image resolves them under `/etc/kafka/secrets`.
- If you see errors like `KAFKA_SSL_KEYSTORE_FILENAME is required` or `KAFKA_SSL_KEY_CREDENTIALS is required`, update your repo and re-run `./generate-certs.sh` so all expected files exist.

Troubleshooting client connection
- Verify the listener is up on your host:
  - `lsof -iTCP:9093 -sTCP:LISTEN -nP`
  - or: `echo | openssl s_client -connect localhost:9093 -servername localhost -CAfile local-test/certs/ca.crt -cert local-test/certs/client.crt -key local-test/certs/client.key -brief`
- If metadata fetch fails with transport errors, make sure the broker is running and `localhost:9093` is reachable. The compose advertises `SSL_HOST://localhost:9093` so clients on the host can connect.
